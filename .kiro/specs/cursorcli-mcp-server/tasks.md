# Implementation Plan: CursorCLI-MCPServer

## プロジェクト概要

CursorCLI-MCPServerは、既存のCursorCLIをModel Context Protocol（MCP）サーバーとして機能拡張するシステムです。本実装計画では、7週間で完全な機能を提供するための段階的な作業を定義します。

## 実装タスク

- [x] 1. プロジェクト基盤とビルド環境の構築
- [x] 1.1 プロジェクト初期化と依存関係管理
  - TypeScriptプロジェクトの初期化（tsconfig.json設定）
  - Node.js v18以上の動作環境確認
  - 必要なnpmパッケージのインストール（`@modelcontextprotocol/sdk`, `zod`, `winston`等）
  - package.jsonのスクリプト設定（ビルド、テスト、開発モード）
  - ESLintとPrettier設定でコード品質管理
  - _Requirements: すべての要件の基盤となる環境構築_

- [x] 1.2 ディレクトリ構造とモジュール基盤の作成
  - ソースコードディレクトリ構造の作成（src/protocol, src/tools, src/config等）
  - 型定義ファイルの配置（types/index.ts）
  - 共通ユーティリティモジュールの基盤作成
  - テストディレクトリ構造の準備（tests/unit, tests/integration）
  - _Requirements: アーキテクチャ設計に基づくモジュール分離_

- [x] 1.3 ロギングシステムの基本実装
  - Winstonロガーの初期化と設定
  - ログレベル管理機能（debug, info, warn, error）
  - コンソールとファイル出力の実装
  - ログフォーマット定義（タイムスタンプ、コンテキスト情報）
  - ログローテーション機能の基本設定
  - _Requirements: 7.1, 7.2, 7.4_

- [ ] 2. 設定管理システムの実装
- [ ] 2.1 設定ファイル読み込みと検証機能
  - 設定ファイルのスキーマ定義（Zodスキーマ）
  - JSONファイル読み込み機能（.cursorcli-mcp/config.json）
  - 設定バリデーション機能の実装
  - デフォルト設定の自動生成機能
  - 環境変数からの設定上書き機能
  - _Requirements: 6.1, 6.2_

- [ ] 2.2 設定変更監視と動的リロード
  - chokidarを使用したファイル監視機能
  - 設定変更時の自動リロード処理
  - 設定変更通知機構の実装
  - 不正な設定値の検出とフォールバック処理
  - _Requirements: 6.6_

- [ ] 3. セキュリティ検証システムの実装
- [ ] 3.1 パス検証とセキュリティチェック
  - プロジェクトルートパスの解決機能
  - 相対パスと絶対パスの正規化処理
  - パストラバーサル検出機能（../による不正アクセス防止）
  - プロジェクトルート外アクセスの検出と拒否
  - ブロックパターンによるファイル除外機能
  - _Requirements: 2.4, 6.5_

- [ ] 3.2 セキュリティエラー処理とログ記録
  - セキュリティエラーの型定義と生成
  - セキュリティ違反の詳細ログ記録
  - 試行されたパスと違反理由の記録
  - セキュリティ統計の収集機能
  - _Requirements: 2.4, 5.1_

- [ ] 4. MCPプロトコルハンドラーの実装
- [ ] 4.1 MCP SDKの統合とサーバー初期化
  - `@modelcontextprotocol/sdk`のServer クラス統合
  - サーバー情報の定義（名前、バージョン、capabilities）
  - 初期化ハンドシェイクの実装
  - プロトコルバージョン管理と互換性チェック
  - クライアント情報の記録と検証
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 4.2 stdio トランスポートの設定
  - StdioServerTransport の初期化
  - 標準入出力ストリームの設定
  - JSON-RPCメッセージのフレーミング処理
  - メッセージ送受信のエラーハンドリング
  - トランスポートライフサイクル管理
  - _Requirements: 1.5, 9.2_

- [ ] 4.3 ツールレジストリの実装
  - ツール登録機能の実装
  - ツール検索とルックアップ機能
  - ツール一覧取得機能（listTools）
  - ツール有効/無効切り替え機能
  - ツールメタデータ管理
  - _Requirements: 1.4_

- [ ] 4.4 ツール実行エンジンの実装
  - ツール呼び出しハンドラー（callTool）
  - パラメータバリデーション処理（Zodスキーマ使用）
  - タイムアウト制御機能（Promise.raceパターン）
  - 同時実行数制限（Semaphoreパターン）
  - ツール実行結果のフォーマット処理
  - _Requirements: 5.4, 8.1, 8.2_

- [ ] 5. ファイル操作ツールの実装
- [ ] 5.1 ファイル読み込み機能（read_file）
  - read_fileツールのスキーマ定義（Zodスキーマ）
  - ファイル存在確認とアクセス権チェック
  - ファイル内容の読み込み処理
  - エンコーディング対応（UTF-8, UTF-16LE, binary）
  - 大容量ファイルの分割読み込み機能（10MB制限）
  - 読み込み結果のレスポンス生成
  - _Requirements: 2.1, 2.5, 8.3_

- [ ] 5.2 ファイル書き込み機能（write_file）
  - write_fileツールのスキーマ定義
  - 書き込み先パスの検証とディレクトリ作成
  - ファイル上書き確認とバックアップ機能
  - 破壊的操作の確認フラグチェック
  - ファイル書き込み処理とエラーハンドリング
  - 書き込み結果のレスポンス生成
  - _Requirements: 2.2, 2.5, 5.5_

- [ ] 5.3 ディレクトリ一覧取得機能（list_directory）
  - list_directoryツールのスキーマ定義
  - ディレクトリ存在確認とアクセス権チェック
  - ファイルとディレクトリの一覧取得
  - ファイルメタデータの収集（サイズ、更新日時、権限）
  - 再帰的ディレクトリ探索機能
  - glob パターンによるフィルタリング
  - _Requirements: 2.3, 8.4_

- [ ] 5.4 ファイル操作の統合とエラーハンドリング
  - ファイル操作共通のエラーハンドリング処理
  - NotFoundError、PermissionError、IOErrorの処理
  - セキュリティ検証との統合
  - ログ記録とデバッグ情報の出力
  - ツールレジストリへの登録処理
  - _Requirements: 2.5, 5.1, 5.2_

- [ ] 6. プロジェクト管理ツールの実装
- [ ] 6.1 プロジェクト情報取得機能（get_project_info）
  - get_project_infoツールのスキーマ定義
  - プロジェクトルートパスの取得
  - プロジェクト設定ファイルの読み込み（.cursor/settings.json）
  - プロジェクトメタデータの収集
  - プロジェクト未初期化時のエラー処理
  - _Requirements: 3.1, 3.4, 3.5_

- [ ] 6.2 ファイル検索機能（search_files）
  - search_filesツールのスキーマ定義
  - glob パターンによるファイル検索
  - .gitignore対応の実装
  - 検索結果の最大件数制限とページネーション
  - 検索結果のソートとフィルタリング
  - _Requirements: 3.2, 8.4_

- [ ] 6.3 ワークスペース構造取得機能（get_workspace_structure）
  - get_workspace_structureツールのスキーマ定義
  - ディレクトリツリーの再帰的構築
  - 最大深さ制限の実装
  - 除外パターンの適用
  - ツリー構造のJSON変換
  - _Requirements: 3.3_

- [ ] 6.4 プロジェクト管理ツールの統合
  - プロジェクト管理共通のエラーハンドリング
  - プロジェクト未初期化エラーの処理
  - CursorCLI Project APIとの統合
  - ツールレジストリへの登録処理
  - _Requirements: 3.4_

- [ ] 7. エディタ制御ツールの実装
- [ ] 7.1 ファイルオープン機能（open_file_in_editor）
  - open_file_in_editorツールのスキーマ定義
  - Cursor IDEとの通信確立
  - ファイルオープン要求の送信
  - 行番号と列番号への移動機能
  - プレビューモード対応
  - IDE未起動時のエラー処理
  - _Requirements: 4.1, 4.5_

- [ ] 7.2 アクティブファイル情報取得（get_active_file）
  - get_active_fileツールのスキーマ定義
  - 現在アクティブなファイルパスの取得
  - カーソル位置情報の取得
  - 選択範囲情報の取得
  - 未保存変更の検出
  - _Requirements: 4.2_

- [ ] 7.3 テキスト編集機能（insert_text, replace_text）
  - insert_textとreplace_textツールのスキーマ定義
  - テキスト挿入位置の計算と検証
  - テキスト置換範囲の検証
  - エディタへの編集要求送信
  - 編集後のカーソル位置更新
  - 編集結果の確認とレスポンス生成
  - _Requirements: 4.3, 4.4_

- [ ] 7.4 エディタ制御の統合と同期処理
  - エディタ操作の順序制御（シーケンシャル実行）
  - 操作完了待機機能
  - CursorCLI Editor APIとの統合
  - エディタ状態変更の追跡
  - ツールレジストリへの登録処理
  - _Requirements: 4.6_

- [ ] 8. モデル情報管理ツールの実装
- [ ] 8.1 現在のモデル情報取得（get_current_model）
  - get_current_modelツールのスキーマ定義
  - Cursor Composerからのモデル情報取得
  - モデルメタデータの整形（名前、プロバイダー、バージョン）
  - コンテキストウィンドウサイズの取得
  - コスト情報の取得（オプショナル）
  - モデル情報取得失敗時のデフォルト値返却
  - _Requirements: 10.1, 10.2, 10.7_

- [ ] 8.2 トークン使用量追跡機能（track_token_usage）
  - track_token_usageツールのスキーマ定義
  - トークン統計ストアの実装（in-memory）
  - 入力/出力トークン数の記録
  - 実行時間の記録
  - モデル別統計の集計
  - 統計データの永続化準備（将来対応）
  - _Requirements: 10.3, 10.6_

- [ ] 8.3 モデル統計情報取得（get_model_statistics）
  - get_model_statisticsツールのスキーマ定義
  - 累積トークン使用量の計算
  - 推定コストの算出
  - 平均実行時間の計算
  - モデル別内訳の生成
  - _Requirements: 10.6_

- [ ] 8.4 モデル切り替え検知とコスト警告
  - モデル変更イベントのログ記録
  - 高コストモデル使用時の警告機能
  - モデル設定の永続化（.cursorcli-mcp/model-preferences.json）
  - ツールレジストリへの登録処理
  - _Requirements: 10.3, 10.4, 10.5_

- [ ] 9. エラーハンドリングシステムの実装
- [ ] 9.1 エラークラスの定義と階層化
  - ValidationError、SecurityError、NotFoundErrorの型定義
  - InfrastructureError、TimeoutError、ResourceExhaustedErrorの型定義
  - BusinessRuleViolationErrorの型定義
  - エラーコードとメッセージの標準化
  - エラー階層の継承構造実装
  - _Requirements: 5.1, 5.2_

- [ ] 9.2 エラーレスポンス生成とJSON-RPC変換
  - エラーレスポンスのフォーマット定義
  - JSON-RPCエラーコードへの変換
  - スタックトレースの整形と出力
  - エラーコンテキスト情報の付加
  - エラーレスポンスのログ記録
  - _Requirements: 5.1_

- [ ] 9.3 グローバルエラーハンドラーと例外処理
  - キャッチされなかった例外のハンドリング
  - プロセスクラッシュ防止機構
  - エラー発生時のグレースフルデグラデーション
  - リカバリ処理の実装
  - _Requirements: 5.6_

- [ ] 10. Cursor IDE統合機能の実装
- [ ] 10.1 Cursor Settings UI連携
  - mcpServers設定フォーマットへの対応
  - 環境変数管理機能（env フィールド）
  - サーバー有効/無効切り替えのサポート
  - 設定同期機能の実装
  - _Requirements: 9.1, 9.6_

- [ ] 10.2 Output Panel連携とログ出力
  - Cursor Output panelへのログ出力実装
  - MCPチャンネルへのログルーティング
  - ログフォーマットの最適化（Output panel用）
  - リアルタイムログストリーミング
  - エラーメッセージの強調表示
  - _Requirements: 9.3, 9.5_

- [ ] 10.3 起動・シャットダウン処理
  - サーバー起動処理の実装（5秒以内目標）
  - 初期化フローの実装
  - グレースフルシャットダウン処理
  - リソース解放とクリーンアップ
  - 起動失敗時の詳細エラーメッセージ出力
  - _Requirements: 9.4, 9.7, 8.6_

- [ ] 10.4 マルチウィンドウサポート
  - 独立したサーバーインスタンスの起動
  - ウィンドウ間の設定分離
  - インスタンス識別機能
  - _Requirements: 9.8_

- [ ] 11. サーバー統計情報機能の実装
- [ ] 11.1 サーバー統計収集機能
  - 稼働時間の追跡
  - リクエスト数のカウント
  - エラー率の計算
  - ツール別実行統計の収集
  - メモリ使用量の監視
  - _Requirements: 7.5, 8.5_

- [ ] 11.2 統計情報提供ツール（get_server_stats）
  - get_server_statsツールのスキーマ定義
  - 統計情報のレスポンス生成
  - リアルタイム統計の取得
  - 統計リセット機能
  - ツールレジストリへの登録
  - _Requirements: 7.5_

- [ ] 12. 単体テストの実装
- [ ] 12.1 Protocol Layerのテスト
  - MCP Protocol Handlerのテスト
  - JSON-RPCメッセージパース処理のテスト
  - ハンドシェイク処理のテスト
  - エラーレスポンス生成のテスト
  - Tool Registryのテスト（登録、検索、有効/無効）
  - _Requirements: すべての要件の基盤となるプロトコル層_

- [ ] 12.2 Configuration Managerのテスト
  - 設定ファイル読み込みのテスト
  - バリデーション処理のテスト
  - デフォルト値適用のテスト
  - 環境変数マージのテスト
  - 設定変更監視のテスト
  - _Requirements: 6.1, 6.2, 6.6_

- [ ] 12.3 Security Validatorのテスト
  - パストラバーサル検出のテスト
  - プロジェクトルート外アクセス防止のテスト
  - パス正規化処理のテスト
  - ブロックパターンマッチングのテスト
  - _Requirements: 2.4, 6.5_

- [ ] 12.4 Tool Layerのテスト
  - File Operations Toolのテスト（read_file, write_file, list_directory）
  - Project Management Toolのテスト（get_project_info, search_files）
  - Editor Control Toolのテスト（モックCursorCLI API使用）
  - Model Info Toolのテスト（統計記録、モデル情報取得）
  - エラーハンドリングのテスト（各種エラーケース）
  - _Requirements: 2.1-2.6, 3.1-3.5, 4.1-4.6, 10.1-10.7_

- [ ] 12.5 テストカバレッジ目標達成
  - カバレッジレポートの生成
  - Critical Path の100%カバレッジ達成
  - 全体の90%カバレッジ達成
  - カバレッジ不足箇所の特定と追加テスト作成
  - _Requirements: すべての要件の品質保証_

- [ ] 13. 統合テストの実装
- [ ] 13.1 E2Eツール実行フローのテスト
  - Cursor Composer → MCP Protocol Handler → Tools → CursorCLI APIの完全フロー
  - ファイル操作フローのテスト（read → write → list）
  - プロジェクト管理フローのテスト（info → search → structure）
  - エディタ制御フローのテスト（open → insert → replace）
  - _Requirements: 2.1-2.6, 3.1-3.5, 4.1-4.6_

- [ ] 13.2 設定管理の統合テスト
  - 設定ファイル読み込みから適用までのフロー
  - 設定変更時の自動リロードテスト
  - 環境変数マージの動作確認
  - 不正な設定値のフォールバック動作確認
  - _Requirements: 6.1, 6.2, 6.6_

- [ ] 13.3 エラーハンドリングパスのテスト
  - バリデーションエラーの伝播テスト
  - セキュリティエラーの処理フロー
  - タイムアウトエラーの発生と処理
  - 各種ビジネスルール違反の処理
  - エラーログ記録の確認
  - _Requirements: 5.1, 5.2, 5.5, 8.1_

- [ ] 13.4 ロギング統合テスト
  - マルチ出力ロギングのテスト（コンソール、ファイル、Output panel）
  - ログローテーション動作の確認
  - ログレベルフィルタリングの動作確認
  - ツール実行ログの記録確認
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [ ] 14. パフォーマンステストの実装
- [ ] 14.1 レイテンシテスト
  - 各ツールの平均実行時間測定（目標: 1秒以内）
  - 最大実行時間測定（目標: 5秒以内）
  - サーバー起動時間測定（目標: 5秒以内）
  - 大容量ファイル処理時間測定（10MB、目標: 3秒以内）
  - _Requirements: 8.1, 8.3, 8.6_

- [ ] 14.2 並行実行テスト
  - 10並行リクエストの同時処理テスト
  - すべてのリクエストが5秒以内に完了することの確認
  - 同時実行数制限の動作確認
  - リソース競合の検証
  - _Requirements: 5.4, 8.2_

- [ ] 14.3 負荷テスト
  - 100リクエスト/分を10分間継続（目標: エラー率5%以下）
  - メモリリークの検証（目標: 500MB以下維持）
  - CPU使用率の監視（目標: 80%以下）
  - 瞬間的な50リクエスト同時送信テスト
  - _Requirements: 8.5_

- [ ] 15. ドキュメントとパッケージング
- [ ] 15.1 ユーザーマニュアルの作成
  - インストール手順の記述
  - Cursor IDE設定方法の説明
  - 各ツールの使用方法と例
  - トラブルシューティングガイド
  - FAQ（よくある質問）
  - _Requirements: すべての要件のユーザー向け説明_

- [ ] 15.2 API仕様書の作成
  - 各ツールのパラメータ仕様
  - レスポンス形式の詳細
  - エラーコード一覧
  - 設定ファイルのスキーマ仕様
  - _Requirements: すべての要件の技術仕様_

- [ ] 15.3 開発者向けドキュメント
  - アーキテクチャ概要の説明
  - コンポーネント構成図
  - コントリビューションガイド
  - 拡張方法（新規ツール追加）
  - _Requirements: 将来的な拡張性の確保_

- [ ] 15.4 パッケージング と配布準備
  - npmパッケージの設定（package.json）
  - バイナリビルドの作成
  - バージョンタグ付け
  - リリースノートの作成
  - GitHubリリースの準備
  - _Requirements: すべての要件の配布準備_

- [ ] 16. 本番環境デプロイ準備
- [ ] 16.1 セキュリティ監査
  - セキュリティレビューの実施
  - 脆弱性スキャンの実行
  - セキュリティベストプラクティスの確認
  - 機密情報漏洩チェック
  - _Requirements: すべての要件のセキュリティ保証_

- [ ] 16.2 パフォーマンスチューニング
  - ボトルネックの特定と解消
  - メモリ使用量の最適化
  - ファイルI/Oの最適化
  - ログ出力の最適化
  - _Requirements: 8.1-8.6のパフォーマンス要件達成_

- [ ] 16.3 最終統合テストと検証
  - 全機能の動作確認
  - エラーケースの網羅的テスト
  - Cursor IDE環境での実地テスト
  - マルチウィンドウシナリオのテスト
  - 長時間稼働テスト（安定性確認）
  - _Requirements: すべての要件の最終検証_

- [ ] 16.4 リリース準備の完了
  - バージョン番号の確定（v1.0.0）
  - CHANGELOGの作成
  - ライセンスファイルの確認
  - 配布パッケージの最終確認
  - リリースアナウンスメントの準備
  - _Requirements: すべての要件のリリース準備_

## 実装スケジュール

### Week 1-2: Core Infrastructure (Tasks 1-4)
プロジェクト基盤、設定管理、セキュリティ、MCPプロトコルハンドラーの実装

### Week 3-4: Tool Implementation (Tasks 5-8)
ファイル操作、プロジェクト管理、エディタ制御、モデル情報ツールの実装

### Week 5: Integration & IDE Support (Tasks 9-11)
エラーハンドリング、Cursor IDE統合、サーバー統計機能の実装

### Week 6: Testing (Tasks 12-14)
単体テスト、統合テスト、パフォーマンステストの実装

### Week 7: Documentation & Deployment (Tasks 15-16)
ドキュメント作成、パッケージング、本番デプロイ準備

## 要件カバレッジマトリクス

| 要件番号  | 要件概要               | 対応タスク                       |
| --------- | ---------------------- | -------------------------------- |
| 1.1-1.5   | MCPプロトコル準拠      | 4.1, 4.2, 4.3, 4.4, 12.1         |
| 2.1-2.6   | ファイル操作ツール     | 5.1, 5.2, 5.3, 5.4, 12.4, 13.1   |
| 3.1-3.5   | プロジェクト管理ツール | 6.1, 6.2, 6.3, 6.4, 12.4, 13.1   |
| 4.1-4.6   | エディタ制御ツール     | 7.1, 7.2, 7.3, 7.4, 12.4, 13.1   |
| 5.1-5.6   | エラーハンドリング     | 9.1, 9.2, 9.3, 12.4, 13.3        |
| 6.1-6.6   | 設定管理               | 2.1, 2.2, 12.2, 13.2             |
| 7.1-7.6   | ロギング               | 1.3, 11.1, 13.4                  |
| 8.1-8.6   | パフォーマンス         | 4.4, 5.1, 14.1, 14.2, 14.3, 16.2 |
| 9.1-9.8   | Cursor IDE統合         | 10.1, 10.2, 10.3, 10.4           |
| 10.1-10.7 | モデル管理             | 8.1, 8.2, 8.3, 8.4, 12.4         |

## 注意事項

- すべてのタスクは順序通りに実行することを推奨します
- 各タスク完了後、単体テストを実行して品質を確保してください
- タスク完了時はこのファイルのチェックボックスをマークしてください
- 問題が発生した場合は、要件または設計ドキュメントを参照してください
- 実装中に設計変更が必要な場合は、design.mdを更新してください
